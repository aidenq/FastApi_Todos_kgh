<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>To-Do List</title>
    <style>
/* === Theme variables === */
:root {
    --bg: #fdfbfb;
    --bg-gradient: linear-gradient(135deg, #fdfbfb, #ebedee);
    --card: #ffffff;
    --card-shadow: rgba(0, 0, 0, 0.1);
    --text-primary: #333333;
    --accent: #6c63ff;
}
[data-theme="dark"] {
    --bg: #1e1e1e;
    --bg-gradient: linear-gradient(135deg, #1e1e1e, #2c2c2c);
    --card: #2a2a2a;
    --card-shadow: rgba(0, 0, 0, 0.55);
    --text-primary: #eaeaea;
    --accent: #8a7dff;
}

* {
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', sans-serif;
    background: var(--bg-gradient);
    color: var(--text-primary);
    margin: 0;
    padding: 2rem;
    transition: background 0.3s ease, color 0.3s ease;
}

.container {
    max-width: 700px;
    margin: 0 auto;
    background: var(--card);
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 10px 25px var(--card-shadow);
    transition: background .3s ease, box-shadow .3s ease;
}

h1 {
    text-align: center;
    margin-bottom: 2rem;
    color: var(--text-primary);
}

h2 {
    margin-top: -0.4rem;
    font-size: 2.0rem;
    color: var(--accent);
}

section.done {
    opacity: .4;
}

ul#today-list, ul#daily-list, ul#weekly-list, ul#monthly-list {
    list-style: none;
    padding: 0;
    margin: 0rem 0 2rem;
}

/* ===== ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ(í•  ì¼) ìŠ¤íƒ€ì¼ ===== */
ul#today-list li,
ul#daily-list li,
ul#weekly-list li,
ul#monthly-list li {
    position: relative;
    background: var(--card);
    border: 1px solid var(--accent);
    border-radius: 8px;
    box-shadow: 0 1px 3px var(--card-shadow);

    padding: 12px 16px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    transition: background 0.15s;
}

ul#today-list li:hover,
ul#daily-list li:hover,
ul#weekly-list li:hover,
ul#monthly-list li:hover {
    background: rgba(108, 99, 255, 0.05);
}

.todo-symbol {
    display: inline-block;
    width: 1.2rem;         /* ê¸°í˜¸ ì˜ì—­ ë„ˆë¹„ (ê¸°í˜¸ê°€ ê°€ìš´ë° ì •ë ¬ë¨) */
    text-align: center;
    margin-right: 0.5rem;  /* ê¸°í˜¸ì™€ í…ìŠ¤íŠ¸ ì‚¬ì´ ê°„ê²© */
    font-size: 1.1rem;
}

/* ===== ë¦¬ìŠ¤íŠ¸ í•­ëª© ë‚´ë¶€ .todo-content ìŠ¤íƒ€ì¼ ===== */
.todo-content {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.todo-content strong {
    font-size: 1rem;
    color: var(--text-primary);
}
.todo-content p {
    font-size: 0.9rem;
    color: #666;
    margin: 0;
    word-break: break-all;
}

/* ===== ë‚ ì§œ ì„ íƒ ë°•ìŠ¤ ===== */
#todo-date {
    display: block;
    width: 100%;
    padding: 0.8rem;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 10px;
    margin-bottom: 1.5rem;
}

/* ===== ì„¹í„° ê·¸ë¦¬ë“œ ë° ì¹´ë“œ ìŠ¤íƒ€ì¼ ===== */
.grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;  /* ì¹´ë“œë“¤ ì‚¬ì´ ê°„ê²© */
    margin: 0;
}

.sector {
    background: var(--card);
    border: 1px solid #ccc;
    border-radius: 10px;
    box-shadow: 0 2px 8px var(--card-shadow);

    min-height: 28rem;
    padding: 1.5rem 3.2rem 4rem; /* ìƒë‹¨ íŒ¨ë”©ì„ ì¤„ì—¬ì„œ í—¤ë”ê°€ ìœ„ë¡œ ë¶™ê²Œ í•¨ */
    font-size: 1.05rem;
    display: flex;
    flex-direction: column;
    transition: box-shadow 0.2s ease;
}
.sector:hover {
    box-shadow: 0 4px 12px var(--card-shadow);
}

.sector-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.add-btn {
    width: 39px;
    height: 39px;
    border: none;
    border-radius: 50%;     /* â† ì´ ë¶€ë¶„ ë•Œë¬¸ì— ì™„ì „í•œ ì›ì´ ë¨ */
    background: var(--accent);
    color: #fff;
    font-size: 1.2rem;
    line-height: 1;
    cursor: pointer;
    transition: background .2s;
}
.add-btn:hover {
    background: #554df5;
}

/* ===== ëª¨ë‹¬(dialog) ê¸°ë³¸ ===== */
.todo-modal {
    border: none;
    border-radius: 1rem;
    padding: 2.5rem 3rem;
    max-width: 420px;
    width: 90%;
    background: var(--card);
    color: var(--text-primary);
    box-shadow: 0 12px 32px var(--card-shadow);
}
.todo-modal::backdrop {
    background: rgba(0, 0, 0, 0.35);
}

/* ===== ëª¨ë‹¬ ë‚´ë¶€ ì…ë ¥ í•„ë“œ ===== */
#modal-form input[type="text"],
#modal-form textarea {
    width: 100%;
    padding: 0.8rem 1rem;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    resize: vertical;
    margin-bottom: 1rem;
}

/* ===== ëª¨ë‹¬ í¸ì§‘ ì „ìš© ë²„íŠ¼ ===== */
#toggle-complete,
#delete-todo {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    cursor: pointer;
}
#toggle-complete {
    background: #28a745;
    color: #fff;
}
#toggle-complete:hover {
    background: #218838;
}
#delete-todo {
    background: #dc3545;
    color: #fff;
}
#delete-todo:hover {
    background: #c82333;
}

/* ===== ëª¨ë‹¬ ì•¡ì…˜(ì €ì¥/ì·¨ì†Œ) ===== */
.modal-actions {
    display: flex;
    gap: 0.8rem;
    justify-content: flex-end;
}
.btn-save {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 0.6rem 1.4rem;
    border-radius: 0.6rem;
    cursor: pointer;
}
.btn-save:hover {
    background: #554df5;
}
.btn-cancel {
    background: transparent;
    border: none;
    cursor: pointer;
}

/* ===== í…Œë§ˆ ì˜¤ë²„ë¼ì´ë“œ ===== */
h2 { color: var(--accent); }
ul#today-list li,
ul#daily-list li,
ul#weekly-list li,
ul#monthly-list li {
    background: var(--card);
    border-color: var(--accent);
    box-shadow: 0 1px 3px var(--card-shadow);
}
    </style>
</head>

<!-- SortableJS ë¡œë“œ -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<body onload="setTodayAndFetchTodos()">
    <!-- ğŸŒ™/â˜€ï¸ í…Œë§ˆ í† ê¸€ -->
    <button id="themeToggle" aria-label="Toggle dark mode"
            style="position:fixed; top:1rem; right:1rem;
                   border:none; background:none; cursor:pointer;
                   font-size:1.5rem;">
        ğŸŒ™
    </button>
    
    <div class="container">
        <h1>ğŸ“‹ To-Do List</h1>
        <input type="date" id="todo-date" onchange="fetchTodosByDate()" />

        <div id="todo-form">
            <div class="grid">
                <!-- ì˜¤ëŠ˜ ì„¹í„° -->
                <section id="today-sector" class="sector">
                    <div class="sector-header">
                        <h2>ì˜¤ëŠ˜ í•  ì¼</h2>
                        <button class="add-btn" data-repeat="none">ï¼‹</button>
                    </div>
                    <ul id="today-list"></ul>
                </section>

                <!-- ë§¤ì¼ ì„¹í„° -->
                <section id="daily-sector" class="sector">
                    <div class="sector-header">
                        <h2>ë§¤ì¼ í•  ì¼</h2>
                        <button class="add-btn" data-repeat="daily">ï¼‹</button>
                    </div>
                    <ul id="daily-list"></ul>
                </section>

                <!-- ë§¤ì£¼ ì„¹í„° -->
                <section id="weekly-sector" class="sector">
                    <div class="sector-header">
                        <h2>ë§¤ì£¼ í•  ì¼</h2>
                        <button class="add-btn" data-repeat="weekly">ï¼‹</button>
                    </div>
                    <ul id="weekly-list"></ul>
                </section>

                <!-- ë§¤ì›” ì„¹í„° -->
                <section id="monthly-sector" class="sector">
                    <div class="sector-header">
                        <h2>ë§¤ì›” í•  ì¼</h2>
                        <button class="add-btn" data-repeat="monthly">ï¼‹</button>
                    </div>
                    <ul id="monthly-list"></ul>
                </section>
            </div>
        </div>

        <!-- â”€â”€â”€ ì¶”ê°€/í¸ì§‘ ëª¨ë‹¬ â”€â”€â”€ -->
        <dialog id="todo-modal" class="todo-modal">
            <form id="modal-form" method="dialog">
                <h3 id="modal-head">í•  ì¼ ì¶”ê°€</h3>

                <input id="m-title" type="text" placeholder="í•  ì¼ ì œëª©" required />
                <textarea id="m-desc" rows="3" placeholder="ì„¤ëª…" required></textarea>

                <!-- í¸ì§‘ ëª¨ë“œ ì „ìš© ë²„íŠ¼ -->
                <div id="edit-buttons" style="display: none; margin-top: 1rem; gap: 0.5rem;">
                    <button type="button" id="toggle-complete">â¬œ ì™„ë£Œ ì²˜ë¦¬</button>
                    <button type="button" id="delete-todo">ì‚­ì œ</button>
                </div>

                <div class="modal-actions">
                    <button value="cancel" class="btn-cancel" formnovalidate>ì·¨ì†Œ</button>
                    <button id="m-save" type="submit" class="btn-save">ì €ì¥</button>
                </div>
            </form>
        </dialog>
    </div>

    <script>
    // â”€â”€â”€ ì „ì—­ ë³€ìˆ˜ â”€â”€â”€
    const modal      = document.getElementById("todo-modal");
    const modalHead  = document.getElementById("modal-head");
    const mTitle     = document.getElementById("m-title");
    const mDesc      = document.getElementById("m-desc");
    const saveBtn    = document.getElementById("m-save");
    let repeatType   = "none";
    let currentTodo  = null; // í¸ì§‘ ëŒ€ìƒì´ ì—†ìœ¼ë©´ ì¶”ê°€ ëª¨ë“œ

    // â”€â”€â”€ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ í•¨ìˆ˜ â”€â”€â”€
    function renderTodoList(listId, todos) {
        const ul = document.getElementById(listId);
        ul.innerHTML = ""; 
        todos.forEach(todo => {
            const li = document.createElement("li");
            li.dataset.id = todo.id;               // ìˆœì„œ ì¬ì •ë ¬ ì‹œ ì‚¬ìš©
            li.className = "";
            li.innerHTML = `
                <span class="todo-symbol">${todo.completed ? 'âœ…' : 'âŒ'}</span>
                <div class="todo-content">
                    <strong>${todo.title}</strong>
                    <p>${todo.description}</p>
                </div>
            `;
            li.addEventListener("click", () => openEditModal(todo));
            ul.appendChild(li);
        });
        // ë“œë˜ê·¸ ì •ë ¬ (SortableJS)
        new Sortable(ul, { animation:150, onEnd: saveNewOrder });
    }

    // â”€â”€â”€ ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì • & ë°ì´í„° ê°€ì ¸ì˜¤ê¸° â”€â”€â”€
    async function setTodayAndFetchTodos() {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("todo-date").value = today;
        await fetch("/todos/generate-recurring");
        fetchTodosByDate();
    }

    // â”€â”€â”€ ì„ íƒëœ ë‚ ì§œì— ë§ëŠ” í•  ì¼ ê°€ì ¸ì˜¤ê¸° â”€â”€â”€
    async function fetchTodosByDate() {
        const selectedDate = document.getElementById("todo-date").value;
        if (!selectedDate) return;

        // 1) ë°˜ë³µ ì¼ì • ìƒì„±
        await fetch("/todos/generate-recurring", { method: "POST" });

        // 2) í•´ë‹¹ ë‚ ì§œì˜ í•  ì¼ ëª©ë¡ ì¡°íšŒ
        const res   = await fetch(`/todos/${selectedDate}`);
        const todos = await res.json();

        // 3) ë°˜ë³µ ìœ í˜•ë³„ë¡œ ë¶„ë¥˜
        const buckets = { none: [], daily: [], weekly: [], monthly: [] };
        todos.forEach(t => {
            (buckets[t.repeat] || buckets.none).push(t);
        });

        // 4) ê° ë¦¬ìŠ¤íŠ¸ì— ë Œë”ë§
        renderTodoList("today-list",   buckets.none);
        renderTodoList("daily-list",   buckets.daily);
        renderTodoList("weekly-list",  buckets.weekly);
        renderTodoList("monthly-list", buckets.monthly);
    }

    // â”€â”€â”€ ìˆœì„œ ì €ì¥ í•¨ìˆ˜ â”€â”€â”€
    async function saveNewOrder(evt) {
        const ul = evt.from;
        const listItems = ul.querySelectorAll("li");
        const newOrder = Array.from(listItems).map(li => parseInt(li.dataset.id));
        await fetch("/todos/reorder", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newOrder)
        });
    }

    // â”€â”€â”€ í¸ì§‘ ëª¨ë‹¬ ì—´ê¸° â”€â”€â”€
    function openEditModal(todo) {
        currentTodo = todo;
        modalHead.textContent = "í•  ì¼ ìˆ˜ì •";
        mTitle.value = todo.title;
        mDesc.value  = todo.description;

        // í¸ì§‘ ì „ìš© ë²„íŠ¼ ë³´ì´ê¸°
        document.getElementById("edit-buttons").style.display = "flex";

        // ì™„ë£Œ í† ê¸€ ë²„íŠ¼ ì„¤ì •
        const toggleBtn = document.getElementById("toggle-complete");
        toggleBtn.textContent = todo.completed ? "âœ… ì™„ë£Œ ìƒíƒœ ì·¨ì†Œ" : "â¬œ ì™„ë£Œ ì²˜ë¦¬";
        toggleBtn.onclick = async () => {
            await toggleComplete(currentTodo.id, currentTodo.completed);
            modal.close();
            fetchTodosByDate();
        };

        // ì‚­ì œ ë²„íŠ¼ ì„¤ì •
        const deleteBtn = document.getElementById("delete-todo");
        deleteBtn.onclick = async () => {
            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            await deleteTodo(currentTodo.id);
            modal.close();
            fetchTodosByDate();
        };

        modal.showModal();
    }

    // â”€â”€â”€ â€œï¼‹â€ ë²„íŠ¼ í´ë¦­: ì¶”ê°€ ëª¨ë“œë¡œ ëª¨ë‹¬ ì—´ê¸° â”€â”€â”€
    document.querySelectorAll(".add-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            currentTodo = null;
            repeatType = btn.dataset.repeat;
            modalHead.textContent =
                { none:"ì˜¤ëŠ˜", daily:"ë§¤ì¼", weekly:"ë§¤ì£¼", monthly:"ë§¤ì›”" }[repeatType] + " í•  ì¼ ì¶”ê°€";
            mTitle.value = "";
            mDesc.value  = "";
            document.getElementById("edit-buttons").style.display = "none";
            modal.showModal();
        });
    });

    // â”€â”€â”€ ëª¨ë‹¬ ì €ì¥ ë²„íŠ¼: ì¶”ê°€ vs ìˆ˜ì • ë¶„ê¸° â”€â”€â”€
    saveBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        const title = mTitle.value.trim();
        const description = mDesc.value.trim();
        const date = document.getElementById("todo-date").value;

        if (!title || !description) {
            alert("ì œëª©Â·ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        if (currentTodo) {
            // â”€â”€ í¸ì§‘ ëª¨ë“œ â”€â”€
            const response = await fetch(`/todos/${currentTodo.id}/edit`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title, description, date })
            });
            if (!response.ok) {
                alert("ìˆ˜ì • ì‹¤íŒ¨!");
                return;
            }
        } else {
            // â”€â”€ ì¶”ê°€ ëª¨ë“œ â”€â”€
            const res = await fetch("/todos", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    id: Date.now(),
                    title,
                    description,
                    completed: false,
                    date,
                    repeat: repeatType,
                    order: 0
                })
            });
            if (!res.ok) {
                alert("ì¶”ê°€ ì‹¤íŒ¨!");
                return;
            }
        }

        modal.close();
        fetchTodosByDate();
    });

    // â”€â”€â”€ ìƒíƒœ í† ê¸€ í•¨ìˆ˜ â”€â”€â”€
    async function toggleComplete(id, currentStatus) {
        const response = await fetch(`/todos/${id}/complete`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ completed: !currentStatus })
        });
        if (!response.ok) {
            alert("ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨!");
        }
    }

    // â”€â”€â”€ ì‚­ì œ í•¨ìˆ˜ â”€â”€â”€
    async function deleteTodo(id) {
        const response = await fetch(`/todos/${id}`, {
            method: "DELETE"
        });
        if (!response.ok) {
            alert("ì‚­ì œ ì‹¤íŒ¨!");
        }
    }

    // â”€â”€â”€ í…Œë§ˆ í† ê¸€(ê¸°ì¡´ ë¡œì§) â”€â”€â”€
    (function() {
        const root   = document.documentElement;
        const toggle = document.getElementById('themeToggle');
        if (!toggle) return;
        const saved = localStorage.getItem('theme');
        if (saved === 'dark') enableDark();

        toggle.addEventListener('click', () => {
            if (root.getAttribute('data-theme') === 'dark') {
                disableDark();
            } else {
                enableDark();
            }
        });

        function enableDark() {
            root.setAttribute('data-theme','dark');
            toggle.textContent = 'â˜€ï¸';
            localStorage.setItem('theme','dark');
        }
        function disableDark() {
            root.removeAttribute('data-theme');
            toggle.textContent = 'ğŸŒ™';
            localStorage.setItem('theme','light');
        }
    })();
    </script>
</body>
</html>
